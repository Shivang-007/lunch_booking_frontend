<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">

    <title>Document</title>
</head>
<script>

    window.onload = function () {

        const t = new Date();
        h = t.getHours();
        m = t.getMinutes();
        if (h >= 12 && h < 15) {
            if ((h == 12 && m >= 30) || h == 13) {
                document.getElementById('arrive_lunch').disabled = false;
            }
            else if (m <= 30 && h == 14) {
                document.getElementById('arrive_lunch').disabled = false;
            }
            else {
                document.getElementById('arrive_lunch').disabled = true;
            }
        }
        if ((h > 14 && m == 30) && (h < 21)) {
            document.getElementById('guest_request').disabled = false;
            document.getElementById('add_request').disabled = false;
        }
        else {
            document.getElementById('add_request').disabled = true;
            document.getElementById('guest_request').disabled = true;
          
        }

    window.onload = function () {

        let paramString = (window.location.href).substring(
            (window.location.href).indexOf("?code") + 1,
            (window.location.href).lastIndexOf("&state")
        );
        let queryString = new URLSearchParams(paramString);
        sessionStorage.setItem("code", queryString);


        url = 'http://localhost:8000/api/getdata';
        data = {
            "code": sessionStorage.getItem("code").substring(5),
            "grant_type": "authorization_code",
            "tenant": "f4814d23-3835-4d87-a7dc-57a19c04684a",
            "client_id": "adc50096-ab75-4d92-bd40-6c4c3ba9b844",
            "client_secret": "HV48Q~a_PBWVnfROz0Oun-1B-ZdMO5fRhdvj0ciK",
            "redirect_uri": "http://localhost:5500/index.html"
        };
        params = {
            method: 'post',
            headers: {
                'Content-type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify(data)
        };

        fetch(url, params).then(function (response) {

            return response.json();
        }).then(function (data) {

            //alert(data);
            var name = data.user.name;
            var mail = data.user.email;
            var token = data.user.remember_token;
            window.sessionStorage.setItem('mail', mail);
            window.sessionStorage.setItem('token', token);

            window.sessionStorage.setItem('name', name);
            window.location.href = 'http://localhost:5500/index.html';
        })
        const d = new Date();
        let h = d.getHours();
        let m = d.getMinutes();
        if (h >= 12 && h < 15) {
            if ((h == 12 && m >= 30) || h == 13) {
                document.getElementById('arrive_lunch').disabled = false;
            }
            else if (m <= 30 && h == 14) {
                document.getElementById('arrive_lunch').disabled = false;
            }


            else {
                document.getElementById('arrive_lunch').disabled = true;



        dateString = sessionStorage.getItem('date');

        var d = new Date(),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) {
            month = '0' + month;
        }
        if (day.length < 2) {
            day = '0' + day;
        }
        formatDate = [year, month, day].join('-');
        dateArray = dateString.split(",");
        for (var i = 0; i < dateArray.length; i++) {
            if (dateArray[i] == formatDate) {

                document.getElementById("arrive_lunch").disabled = true;
            }
        }


    };

    function addRequest() {
        var mail = window.sessionStorage.getItem("mail");
        url = 'http://127.0.0.1:8000/api/add-request';
        data = { "mail": mail };
        params = {
            method: 'post',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify(data)
        };
        fetch(url, params).then(function (response) {
            if (response.status == 409) {
                alert('You already registered for Lunch');
                location.reload();
            }
        }

        // const date = new Date();
        // let hour = date.getHours();
        // let minutes = date.getMinutes();

        // if (hour >= 12 && hour <= 21) {

            }
            else if (response.status == 404) {
                alert('Something went wrong');
                location.reload();
            }
            else {
                alert('Add Request Successfully');
                location.reload();
                return response.json();

        //     document.getElementById('add_request').disabled = false;
        //     document.getElementById('guest_request').disabled = false;
        // }
        // else {
        //     document.getElementById('add_request').disabled = true;
        //     document.getElementById('guest_request').disabled = true;
        // }


            }
        })
    }

        var disdate = sessionStorage.getItem('date');
        dateArray = disdate.split(",");
        var dd = new Date(),
            month = '' + (dd.getMonth() + 1),
            day = '' + dd.getDate(),
            year = dd.getFullYear();

        if (month.length < 2) {
            month = '0' + month;
        }
        if (day.length < 2) {

            day = '0' + day;
        }

        var formatDate = [year, month, day].join('-');

        const myArrayy = disdate.split(",");
       
        for (var i = 0; i <= myArrayy.length; i++) {

            if (myArrayy[i] == formatDate) {


                
                document.getElementById('arrive_lunch').disabled = true;
            }


        }


    }





    // function addRequest() {
    //     var mail = window.sessionStorage.getItem("mail");
    //     var token = sessionStorage.getItem("token");
    //     // alert(token);
    //     url = 'http://127.0.0.1:8000/api/add-request';
    //     data = { "mail": mail, "token": token };
    //     params = {
    //         method: 'post',
    //         headers: {
    //             'Content-type': 'application/json'
    //         },
    //         body: JSON.stringify(data)
    //     };
    //     fetch(url, params).then(function (response) {
    //         if (response.status == 409) {
    //             alert('You already registered for Lunch');
    //             location.reload();
    //         }
    //         else if (response.status == 503) {
    //             alert('Its Holiday,Not able To Add Request');
    //             location.reload();

    //         }
    //         else if (response.status == 404) {
    //             alert('Something went wrong');
    //             location.reload();
    //         }
    //         else {
    //             alert('Add Request Successfully');
    //             location.reload();
    //             return response.json();


    //         }
    //     })
    // }


    // function addGuest() {
    //     var mail = sessionStorage.getItem("mail");
    //     var token = sessionStorage.getItem("token");
    //     var guest = document.getElementById('add_guests').value;
    //     url = 'http://127.0.0.1:8000/api/add-guests';
    //     data = { "mail": mail, 'guests': guest, "token": token };
    //     params = {
    //         method: 'post',
    //         headers: {
    //             'Content-type': 'application/json'
    //         },
    //         body: JSON.stringify(data)
    //     };
    //     fetch(url, params).then(function (response) {
    //         if (response.status == 409) {
    //             alert('You already registered for Lunch');
    //             location.reload();

    //         }
    //         else if (response.status == 503) {
    //             alert('Its Holiday,Not able To Add Request');
    //             location.reload();

    //         }
    //         else if (response.status == 401) {
    //             alert('Something went wrong');
    //             location.reload();

    //         }
    //         else {
    //             alert('Add Request Successfully');
    //             location.reload();
    //             return response.json();
    //         }
    //     })

    // }
    // function deleteRequest() {

    //     var mail = sessionStorage.getItem("mail");
    //     var token = sessionStorage.getItem("token");
    //     url = 'http://127.0.0.1:8000/api/delete-request';
    //     data = { "mail": mail, "token": token };
    //     params = {
    //         method: 'post',
    //         headers: {
    //             'Content-type': 'application/json'

    //         },
    //         body: JSON.stringify(data)
    //     };
    //     fetch(url, params).then(function (response) {
    //         if (response.status == 503) {
    //             alert('Its Holiday,Not able To Add Request');
    //             location.reload();

    //         }
    //         else if (response.status == 404) {
    //             alert('You are not registered for lunch');
    //             location.reload();

    //         }
    //         else {
    //             alert('Delete Request Successfully');
    //             location.reload();
    //             return response.json();
    //         }
    //     })

    // }

    function arriveLunch() {

        var mail = window.sessionStorage.getItem("mail");
        var token = sessionStorage.getItem("token");

        url = 'http://127.0.0.1:8000/api/lunch-taken';
        data = { "mail": mail, "token": token };
        params = {
            method: 'post',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify(data)
        };
        fetch(url, params).then(function (response) {
            if (response.status == 409) {
                alert('You already registered for Lunch');
                location.reload();
            }
            else if (response.status == 503) {
                alert('Its Holiday, Not able To Add Request');
                location.reload();

            }
            else if (response.status == 404) {
                alert('Something went wrong');
                location.reload();
            }
            else {
                alert('Lunch Taken');
                location.reload();
                return response.json();


            }
        })

    }

    function logout() {

        var mail = sessionStorage.getItem("mail");
        var token = sessionStorage.getItem("token");
        // alert(mail);
        url = 'http://localhost:8000/api/signout';
        data = { "mail": mail, "token": token };

        params = {
            method: 'post',
            headers: {
                'Content-type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify(data)
        };

        fetch(url, params).then(function (response) {
            if (response.status == 200) {
                sessionStorage.removeItem("mail");
                sessionStorage.removeItem("name");
                window.location.href = "http://localhost:5500/login.html";

            }
            else {
                alert('Something went wrong');


            }

        });


    }
    function offDay() {
       
        var mail = sessionStorage.getItem("mail");
        var token = sessionStorage.getItem("token");
        // alert(mail);
        url = 'http://127.0.0.1:8000/api/off-day';
        data = { "mail": mail, "token": token };
        params = {
            method: 'post',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify(data)
        };

        fetch(url, params)
            .then((response) => {


                window.location.href = 'http://localhost:5500/offDay.html';
                return response.json();

            }).then((data) => {
                

            }).then((data) => {
                // console.log(data);
                date = '';
                for (i = 0; i < data[0].length; i++) {
                    date = date + data[0][i].weekend + ',';
                }
                
                sessionStorage.setItem('date', date);
               

                //    alert(date);
                //     console.log(date);
                sessionStorage.setItem('date', date);
                // alert(sessionStorage.getItem('date'));
            });

    }
    
</script>

<body>

    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Lunch Booking</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" style="cursor: pointer;" onclick="offDay()">Off-Day</a>

                        <a class="nav-link" onclick="offDay()" style="cursor:pointer;">Off-Day</a>
                    </li>
                </ul>

                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

                    <li class="nav-item mt-1 me-1" id="myname">
                        Welcome,
                        <script>document.write(window.sessionStorage.getItem('name'));</script>
                        Welcome,<script>document.write(window.sessionStorage.getItem('name'));</script>
                    </li>
                    <button class="btn btn-success" onclick="logout()">Logout</button>
                </ul>
            </div>
        </div>
    </nav>




    <div class="container">
        <div class="image">
            <img src="images/simform_logo.png" class="img-fluid" alt="Responsive image">
        </div>
        <br>
        <div class="request-heading">
            <h2>Your Lunch</h2>
        </div>
        <hr>
        <!-- <div class="request-button">
            <button class="btn btn-primary" disabled onclick="addRequest()" style="width: 70%;" id="add_request">Add
                Request</button>
        </div>
        <div class="request-button">
            <button class="btn btn-primary" disabled onclick="openGuest()" style="width: 70%;"
                id="guest_request">Request with
                guests</button>
        </div>
        <div class="request-button">
            <button class="btn btn-primary" onclick="deleteRequest()" style="width: 70%;" id="delete_request">Delete
                Request</button>
        </div> -->
        <div class="request-button">
            <button class="btn btn-primary" disabled style="width: 70%;" id="arrive_lunch"
                onclick="arriveLunch()">Arrive for
                Lunch</button>


        </div>
    </div>
    <!-- <div class="popup" id="popup">
        <div class="popup-content">
            <a href=""><img src="images/close_button.png" class="close" alt="close"></a>
            <img src="images/add_guests.png" height="70px" width="70px" alt="guests">

            <div class="mb-3">
                <h5><label class="form-label">Add Guests</label></h5>
                <input type="number" class="form-control" id="add_guests" name="guest_number"
                    placeholder="Add Number of Guests here" oninput="this.value = 
                    !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null">

            </div>
            <div>
                <button class="btn btn-primary" onclick="addGuest()" style="width: 70%;height: 50px;">Add
                    Guests</button>
            </div>
        </div>
    </div> -->



    <script src="script.js"></script>
</body>




</html>